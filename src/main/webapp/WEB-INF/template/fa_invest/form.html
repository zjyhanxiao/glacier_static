<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
    <title>
        美信金融|投资流程
    </title>
    <link rel="stylesheet" href="${static}/vendor/css/bootstrap.min.css">
    <link href="${static}/dist/meixin_invest/css/base.min.css" rel="stylesheet">
    <link href="${static}/dist/meixin_invest/css/detail-new.min.css" rel="stylesheet">
    <link href="${static}/dist/meixin_invest/css/index.min.css" rel="stylesheet">
    <link href="${static}/dist/meixin_invest/css/fa_invest.min.css" rel="stylesheet">
    <#include "includes/oneapm.html" />
    <#include "includes/ga.html" />
    <script>
    var _hmt = _hmt || [];
    (function()
    { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?36100da860ed74085d2bdd67bdbdbf5e"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); }
    )();
    </script>
    <!--[if lt IE 9]>
    <script src="${static}/vendor/js/html5shiv"></script>
    <script src="${static}/vendor/js/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div id="wrapper" class="customer">
     <#include "includes/navbar.html" />
     <div class="container-fluid">
         <section class="text-center" style="margin-top: 70px;">
             <div class="row">
                 <div class="col-sm-10 col-sm-offset-1">
                     <div class="fa-steps-bullets international-bullets-extra-styles">
                         <div><p><span>1</span></p>上传身份证件</div>
                         <div><p><span>2</span></p>投资人基本信息</div>
                         <div><p><span>3</span></p>家庭住址</div>
                         <div><p><span>4</span></p>确认投资</div>
                         <hr/>
                         <span class="clearfix"></span>
                     </div>
                     <form class="fa-steps col-sm-10 col-sm-offset-1" data-parsley-validate>
                         <div class="step-section">
                             <p>根据美国监管要求，国际投资人需要上传身份证件以核实投资者身份信息。</p>
                             <p>您需要上传您的身份证扫描（或照片）以及护照信息页扫描件（或照片）。如果您没有护照，可以只选择上传身份证扫描（或照片）</p>
                             <div class="fa-upload-id-pic fa-upload-pic col-sm-5">
                                 <a class="btn btn-primary">上传身份证照片</a>
                                 <#if investor_profile.identification_card_photo != "meixin_invest/user/default.png">
                                     <img src="${media}${investor_profile.identification_card_photo}">
                                     <p>您已上传的身份证照片</p>
                                     <input id="id_card_photo" name="id_card_photo" type="file"
                                        data-parsley-required-message="请上传身份证照片！"/>
                                 <#else>
                                     <img src="${static}/meixin_invest/img/fa_invest/fa_id_placeholder_650x396.png">
                                     <p>要求：请上传正面照片，字迹清晰，四边完整</p>
                                     <input id="id_card_photo" name="id_card_photo" type="file" required=""
                                            data-parsley-required-message="请上传身份证照片！"/>
                                 </#if>

                             </div>
                             <div class="fa-upload-passport-pic fa-upload-pic col-sm-5 col-sm-offset-2">
                                 <a class="btn btn-primary">上传护照照片</a>
                                 <#if investor_profile.passport_photo != "meixin_invest/user/default.png">
                                     <img src="${media}${investor_profile.passport_photo}">
                                     <p>您已上传的护照照片</p>
                                 <#else>
                                     <img src="${static}/meixin_invest/img/fa_invest/fa_passport_placeholder_650x396.png">
                                     <p>要求：请上传护照首页照片，字迹清晰，四边完整</p>
                                 </#if>
                                 <input id="passport_photo" name="passport_photo" type="file"/>
                             </div>
                             <span class="clearfix"></span>
                         </div>

                         <div class="step-section label-left basic-info">
                             <p style="color: red;">请填写汉语拼音和阿拉伯数字</p>
                             <label>姓氏：</label>
                             <input id="lastname" name="last-name" class="form-control" placeholder="姓的汉语拼音"
                                    required="" data-parsley-pattern="/^([a-zA-Z]+)$/"
                                    data-parsley-pattern-message="输入信息有误！">
                             <label>名：</label>
                             <input id="firstname" name="first-name" type="text" class="form-control"
                                    placeholder="名的汉语拼音" required="" data-parsley-pattern="/^([a-zA-Z]+)$/"
                                    data-parsley-pattern-message="输入信息有误！">
                             <label>所在国家/地区：</label>
                             <select id="countries_states" class="form-control bfh-countries" data-country="CN"
                                     required=""></select>
                             <label style="text-align: center;">所在州/省：</label>
                             <select id="state" class="form-control bfh-states" data-country="countries_states"
                                     data-state="BE" required=""></select>
                             <label>身份证号：</label>
                             <input id="id-card-number" class="form-control" required="">
                             <label>护照号：</label>
                             <input id="passport" class="form-control" required=""
                                    data-parsley-pattern="/^[A-Za-z0-9]{9}$/"
                                    data-parsley-pattern-message="护照号格式不正确！">
                             <label>出生日期：</label>
                             <input type="text" id="birth-date" name="birthdate" placeholder="YYYY-MM-DD" class="form-control" required="" data-parsley-pattern="/(^(19|[2-9][0-9])\d\d[\-](((0[1-9]|1[012])[\-](0[1-9]|1[0-9]|2[0-8]))|((0[13578]|1[02])[\-](29|30|31))|((0[4,6,9]|11)[\-](29|30)))$)|(^(19|[2-9][0-9])(00|04|08|12|16|20|24|28|32|36|40|44|48|52|56|60|64|68|72|76|80|84|88|92|96)[\-]02[\-]29$)/" maxlength="10" data-parsley-pattern-message="日期格式不正确">
                         </div>

                         <div class="step-section label-left">
                             <p style="color: red;">请填写汉语拼音和阿拉伯数字</p>
                             <label>城市：</label>
                             <input id="city" class="form-control" required=""
                                    placeholder="请填写城市名的拼音，例如”北京市“请填写“Beijing”" onblur="ReplaceDot('city')">
                             <label>街道名：</label>
                             <input id="street" class="form-control" required=""
                                    placeholder="请填写街道名的拼音，例如“人民路”请填写“Renminlu”" onblur="ReplaceDot('street')">
                             <label>门牌号码：</label>
                             <input id="door" class="form-control" required=""
                                    placeholder="请填写街道的门牌号码，例如“人民路1号”请填写“1”" onblur="ReplaceDot('door')">
                             <label>公寓号：</label>
                             <input id="apartment" class="form-control"
                                    placeholder="请填写公寓房间号码，例如“601室”请填写”Room 601“" onblur="ReplaceDot('apartment')">
                             <label>邮政编码：</label>
                             <input id="zipcode" class="form-control" required="" placeholder="请填写准确的邮政编码" onblur="ReplaceDot('zipcode')">
                         </div>

                         <div class="step-section payment-section text-left radio-custom label-left">
                             <label>投资金额：</label>
                             <input data-parsley-pattern="/^([1-9][0-9]{0,1}0000)$|^([1-9][0-9]{0,1}[5]000)$/"
                                    data-parsley-pattern-message="最低投资金额：$10,000，必须为5000的倍数" id="invest-amount" name="invest-amount"
                                    class="form-control"
                                    placeholder="最低投资金额：$10,000，必须为5000的倍数" required="" onkeypress="return event.charCode === 0 || /\d/.test(String.fromCharCode(event.charCode));" />
                             <section>
                                 <label>投资方式：</label>
                                 <div class="payment-option">
                                     <input type="radio" name="payment" id="ach-online" payment-method="ach"
                                            required="" data-parsley-required-message="请选择支付方式"/>
                                     <label for="ach-online"><span><span></span></span>ACH在线自动转账（最方便、需要美国银行账户、账户姓名需与投资人姓名一致）</label><br>
                                     <input type="radio" name="payment" id="bank-tt" payment-method="wire"/>
                                     <label for="bank-tt"><span><span></span></span>银行电汇（从非美国银行账户）</label><br>

                                     <input type="radio" name="payment" id="check" payment-method="check"/>
                                     <label for="check"><span><span></span></span>支票</label>
                                 </div>
                             </section>
                             <div class="ach-online-box">
                                 <label><img src="${static}/meixin_invest/img/fa_invest/fa_pay_name_60x58.png"/></label>
                                 <input id="bank-account-name" class="form-control" placeholder="Name On Account"/>
                                 <label><img
                                         src="${static}/meixin_invest/img/fa_invest/fa_pay_routing_60x54.png"/></label>
                                 <input id="routing-number" class="form-control"
                                        placeholder="9 Digit Bank Routing Number"/>
                                 <label><img src="${static}/meixin_invest/img/fa_invest/fa_pay_account_54x60.png"/></label>
                                 <input id="bank-account-number" class="form-control"
                                        placeholder="Bank Account Number"/>
                                 <div class="accout-check-type">
                                     <label>Accout Type</label>
                                     <span id="accouttype">
                                     <label for="accoutType-checking"><input type="radio" name="accoutType"
                                                                             id="accoutType-checking"
                                                                             accounttype="checking"/><span>Checking</span></label>
                                     <label for="accoutType-saving"><input type="radio" name="accoutType"
                                                                           id="accoutType-saving"
                                                                           accounttype="savings"/><span>Savings</span></label>
                                     </span>
                                     <label>Check Type</label>
                                     <span id="checktype">
                                     <label for="checkType-personal"><input type="radio" name="checkType"
                                                                            id="checkType-personal"
                                                                            checktype="personal"/><span>Personal</span></label>
                                     <label for="checkType-business"><input type="radio" name="checkType"
                                                                            id="checkType-business"
                                                                            checktype="business"/><span>Business</span></label>
                                     </span>
                                 </div>
                                 <input type="checkbox" name="agreement" id="achAgreement"/>
                                 <label for="achAgreement"><span><span></span></span>我已认真阅读并接受<a
                                         href="${static}/meixin_invest/doc/ACH-AUTHORIZATION-AGREEMENT.pdf"
                                         target="blank">《ACH AUTHORIZATION
                                     AGREEMENT》</a></label><br>
                                 <input type="checkbox" name="agreement" id="agreement-01"/>
                                 <label for="agreement-01"><span><span></span></span>我已认真阅读并接受<a href="${static}/meixin_invest/doc/${product.subscription_agreement_name}" target="blank">《认购协议》</a></label>
                                 <div class="sign-name">
                                     <label>签名：</label>
                                     <input id="ach-signature" class="form-control" placeholder="请输入您的名字与姓的拼音以确认"
                                            name="signature"/>
                                 </div>
                             </div>
                             <div class="bank-tt-box">
                                 <p><span>汇款信息：</span></p>
                                 <p><span>备注栏请填写：</span>

                                         YOUR NAME & ${product.external_name}

                                 </p>
                                 <p><span>收款人名字：</span>Fund America Securities, LLC</p>
                                 <p><span>收款人地址：</span>3455 Peachtree Road, NE 5th Floor Atlanta, GA 30326</p>
                                 <p><span>账户号Account #：</span>0001476100</p>
                                 <p><span>收款路径号ABA/Routing #：</span>122242869</p>
                                 <p><span>Swift Code：</span>PMERU66</p>
                                 <p><span>收款银行：</span>Pacific Mercantile Bank</p>
                                 <p><span>收款银行地址：</span>949 South Coast Drive, Third Floor Costa Mesa, CA 92626,
                                     (714)438-2500</p>
                                 <p><span>注意：请您在接收到我们邮件通知您投资人身份审核通过后再前往银行进行汇款</span></p>
                                 <input type="radio" name="agreement" id="agreement-02"
                                        data-parsley-required-message="请阅读并接受认购协议"/>
                              
                                 <label for="agreement-02"><span><span></span></span>我已认真阅读并接受<a
                                         href="${static}/meixin_invest/doc/${product.subscription_agreement_name}"
                                         target="blank">《认购协议》</a></label>
                                 <div class="sign-name">
                                     <label>签名：</label>
                                     <input id="wire-signature" class="form-control" placeholder="请输入您的名字与姓的拼音以确认">
                                 </div>
                             </div>
                             <div class="check-box">
                                 <p><span>收款人：</span>FUNDAMERICA SECURITIES</p>
                                 <p><span>备注栏请填写：</span>
                                     YOUR NAME ${product.external_name}
                                 </p>
                                 <p><span>请将支票寄至以下地址：</span></p>
                                 <p>FundAmerica Securities</p>
                                 <p>3455 Peachtree Road, NE</p>
                                 <p>5th Floor</p>
                                 <p>Atlanta, GA 30326</p>
                                 <p><span>注意：我们目前只接受来自美国银行账户的支票</span></p>
                                 <input type="radio" name="agreement" id="agreement-03"
                                        data-parsley-required-message="请阅读并接受认购协议"/>
                                 <label for="agreement-03"><span><span></span></span>我已认真阅读并接受<a
                                         href="${static}/meixin_invest/doc/${product.subscription_agreement_name}"
                                         target="blank">《认购协议》</a></label>
                                 <div class="sign-name">
                                     <label>签名：</label>
                                     <input id="check-signature" class="form-control" placeholder="请输入您的名字与姓的拼音以确认">
                                 </div>
                             </div>
                         </div>

                         <div class="step-navigation">
                             <button type="button" class="previous btn btn-primary pull-left">返回</button>
                             <button type="button" class="next btn btn-primary pull-right">下一步</button>
                             <button type="fasubmit" id="submit-button" class="btn btn-primary pull-right"><span class="glyphicon glyphicon-refresh spinning" style="display: none;"></span><span>提交</span></button>
                             <span class="clearfix"></span>
                         </div>
                     </form>

                     <div class="invest_info">
                         <h2>申购成功</h2>
                         <p>您的款项到账后将收到邮件通知</p>
                         <p></p>
                         <div class="row success-links">
                             <h3>与此同时，您还可以：</h3>
                             <div class="col-sm-offset-3 col-sm-2">
                                 <img src="${static}/meixin_invest/img/fa_invest/icon_moreproducts_512x512.png" />
                                 <a href="/product_list" target="_blank" class="btn btn-primary">浏览更多产品</a>
                             </div>
                             <div class="col-sm-2">
                                 <img src="${static}/meixin_invest/img/fa_invest/icon_myaccount_512x512.png" />
                                 <a href="/investor/dashboard" target="_blank" class="btn btn-primary">查看我的账户</a>
                             </div>
                             <div class="col-sm-2">
                                 <img src="${static}/meixin_invest/img/fa_invest/icon_news_512x512.png" />
                                 <a href="//news.meixinfinance.com" target="_blank" class="btn btn-primary">查看财经资讯</a>
                             </div>
                         </div>
                     </div>

                 </div>
             </div>
         </section>
     </div>
 </div>
 <#include "includes/footer.html" />
<link rel="shortcut icon" type="image/png" href="${static}/dist/meixin_invest/img/favicon.png">
<link rel="stylesheet" href="${static}/vendor/css/font-awesome.min.css">
<script src="${static}/vendor/js/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="${static}/vendor/js/jquery-ui.min.js" type="text/javascript"></script>
<script src="${static}/vendor/js/bootstrap.min.js" type="text/javascript"></script>
<script src="${static}/dist/meixin_invest/js/navi.min.js" type="text/javascript"></script>
<script>
    $(document).ready(function(){
        $('#wechat-popover').popover({
            html : true,
            placement : 'bottom',
            trigger : 'hover',
            content : '<img style="width: 200px;padding:0;margin:0;" src="${static}/meixin_invest/img/meixin_new_qr_code_300x300.jpg" />'
        });
    });
</script>
<script src="${static}/dist/meixin_invest/js/bootstrap-formhelpers.min.js"></script>
<script src="${static}/dist/meixin_invest/js/bootstrap-formhelpers-states.min.js"></script>
<script src="${static}/dist/meixin_invest/js/bootstrap-formhelpers-countries-nousa.zh_CN.min.js"></script>
<script src="${static}/meixin_invest/js/parsley.min.js"></script>
<script src="${static}/dist/meixin_invest/js/fa_invest_general.min.js"></script>
<script src="${static}/dist/meixin_invest/js/jquery.cookie.min.js"></script>
<script src="${static}/dist/meixin_invest/js/fa.min.js"></script>
<script>
    function ReplaceDot(id){
        var Obj=document.getElementById(id);
        while(Obj.value.indexOf("。")!=-1 || Obj.value.indexOf("，")!=-1){
            Obj.value=Obj.value.replace("。",".");
            Obj.value=Obj.value.replace("，",",");
        }
    }
    function getUserInvestorProfile(fa_invest_data) {
        // get investor profile from meixin database
        $.ajax({
            url: '/api/investor/investor_profile',
            dataType: 'json',
            async: false,
            data: {},
            success: function (result, status) {
            	console.log(result);
                fa_invest_data['user_id'] = result.user_id;
                fa_invest_data['entity_id'] = result.entity_id;
                console.log(result);
                console.log('investor_profile');
            },
            error: function (result, status) {
                console.log(result);
            },
            fail: function (result, status) {
                console.log(result);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    function getFaEntity(fa_invest_data) {
        // get FA entity information
        console.log(fa_invest_data['entity_id']);
        console.log("getFaEntity");
        $.ajax({
            url: '/fund_america/entities' + '/' + fa_invest_data['entity_id'],
            dataType: 'json',
            method: 'GET',
            async: false,
            data: {},
            success: function (result, status) {
                console.log(result);
                var name = result.name.split(" ");
                var firstname = name[0];
                var lastname = name[1];
                $("#firstname").attr("value", firstname);
                $("#lastname").attr("value", lastname);
                $("#birth-date").attr("value", result.date_of_birth);
                $("#street").attr("value", result.street_address_1);
                $("#apartment").attr("value", result.street_address_2);
                $("#zipcode").attr("value", result.postal_code);
                $("#city").attr("value", result.city);
                fa_invest_data['phone'] = result.phone;
            },
            error: function (response) {
                console.log(response);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }


    // FA API Call 1: Subscription Agreement
    function faSubscriptionAgreement(data) {
        $.ajax({
            url: '/fund_america/subscription_agreements',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'equity_share_count': 10,
                'offering_id': "${offering_id}",
                'vesting_amount': $("#invest-amount").val(),
                'vesting_as': user_signature,
                'vesting_as_email': '${user.email}',
                'debt_par_value': 5000,
            },
            success: function (result, status) {
                console.log(result);
                console.log("post success");
                data['agreement_id'] = result.id;
                data['agreement_url'] = result.url;
                if (result.electronic_signatures[0]['anchor_id'] == 'subscriber_signature') {
                    data['sign_id'] = result.electronic_signatures[0].id;
                } else {
                    data['sign_id'] = result.electronic_signatures[1].id;
                }
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "协议填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 2: Electronic Signature
    function faSignature(data) {
        $.ajax({
            url: '/fund_america/electronic_signatures' + '/' + data['sign_id'],
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'ip_address': '${user_ip}',
                'name': user_signature,
                'email': '${user.email}',
                'user_agent': window.navigator.userAgent,
                'literal': user_signature
            },
            success: function (result, status) {
                console.log("fa sign success");
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "签名有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 3: Entity
    function faEntity(data) {
        var phone = '';
        if(data['phone']){
            phone = data['phone'];
        }else{
            phone = '${investor_profile.telephone}';
        }
        $.ajax({
            url: '/fund_america/entities',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'country': $("#countries_states").find("option").filter(":selected").attr("value"),
                'region': $("#state").find("option").filter(":selected").attr("value"),
                'city': $('#city').val(),
                'street_address_1': $('#door').val() + ' ' + $('#street').val(),
                'street_address_2': $('#apartment').val(),
                'postal_code': $('#zipcode').val(),
                'email': '${user.email}',
                'phone': phone,
                'name': $("#firstname").val() + " " + $("#lastname").val(),
                'date_of_birth': $('#birth-date').val(),
                'tax_id_number': passport2TaxId($('#passport').val()),
                'type': 'person',
                'entity_type': 'person'
            },
            success: function (result, status) {
                console.log("save fa entity");
                data['entity_id'] = result.id;
                console.log(data['entity_id']);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "投资人信息填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 5 (Optional): ACH
    function faAchAuthorization(data) {
        $.ajax({
            url: '/fund_america/achs',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'account_number': $('#bank-account-number').val(),
                'account_type': $("#accouttype input").filter(":checked").attr("accounttype"),
                'address': $('#street').val(),
                'check_type': $("#checktype input").filter(":checked").attr("checktype"),
                'city': $('#city').val(),
                'email': '${user.email}',
                'entity_id': data['entity_id'],
                'ip_address': '${user_ip}',
                'literal': user_signature,
                'name_on_account': $('#bank-account-name').val(),
                'routing_number': $('#routing-number').val(),
                'state': $("#state").find("option").filter(":selected").attr("value"),
                'user_agent': user_browser,
                'zip_code': $('#zipcode').val(),
            },
            success: function (result, status) {
                console.log("ach call success");
                data['ach_authorization_id'] = result.id;
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "ACH填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 6: Investments
    function faInvestment(data) {
        var now = {
            'offering_id': '${offering_id}',
            'amount': $("#invest-amount").val(),
            'entity_id': data['entity_id'],
            'subscription_agreement_id': data['agreement_id'],
            'payment_method': $(".payment-option input").filter(":checked").attr("payment-method"),
            'review_trade': 'false'
        };
        if ($(".payment-option input").filter(":checked").attr("payment-method") == 'ach') {
            now['ach_authorization_id'] = data['ach_authorization_id'];
        }
        $.ajax({
            url: '/fund_america/investments',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: now,
            success: function (result, status) {
                console.log('invest success');
                data['external_id'] = result.id;
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "投资填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }
    // Meixin Order Api Call
    function saveToMeixinOrder(data) {
        $.ajax({
            url: '/api/orders',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'product': "${product.id}",
                'invest_amount': $("#invest-amount").val(),
                'payment_method': $(".payment-option input").filter(":checked").attr("payment-method"),
                'external_id': data['external_id']
            },
            success: function (result, status) {
                console.log('order save success');
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "订单填写有误";
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // Meixin Profile Api Call
    function saveMeixinEntity(data) {
        $.ajax({
            url: '/api/investor/update_investor_profile',
            dataType: 'json',
            method: 'post',
            async: false,
            data: {
                'external_entity_id': data['entity_id'],
                'real_name': $("#firstname").val() + " " + $("#lastname").val(),
                'id_card_code': $("#id-card-number").val(),
            },
            success: function (result, status) {
                console.log('meixin entity save success');
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "用户信息存储有误";
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // Meixin Indentification Photo Api Call
    function saveToMeixinPhoto(data) {
        var formData = new FormData(this);
        if ($('#id_card_photo').get(0).files.length != 0) {
            formData.append('id_card_photo', $("#id_card_photo")[0].files[0]);
        }
        if ($('#passport_photo').get(0).files.length != 0) {
            formData.append('passport_photo', $("#passport_photo")[0].files[0]);
        }

        $.ajax({
            url: '/api/investor/upload_photo',
            dataType: 'json',
            method: 'post',
            data: formData,
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success: function (result, status) {
                console.log('meixin photo save success');
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "照片上传有误";
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    var user_browser;
    var user_signature;
    var is_success = true;
    var fa_invest_data = {}
    var error;
    var error_detail;

    $(document).ready(function () {
        user_browser = window.navigator.appName;
        console.log(user_browser);
        getUserInvestorProfile(fa_invest_data);
        if(fa_invest_data['entity_id']){
            getFaEntity(fa_invest_data);
        }
    });

    function curIndex() {
        return $('.step-section').index($('.step-section').filter('.current'));
    }

    // handle submission
    $('#submit-button').click(function () {
        if ($('.fa-steps').parsley().validate({group: 'block-' + curIndex()})) {

            $('#submit-button').attr("disabled","disabled");
            $('#submit-button span').eq(0).show();
            $('#submit-button span').eq(1).text(" 提交中...");

            setTimeout(function () {
                if ($(".payment-option input").filter(":checked").attr("payment-method") == "ach") {
                    user_signature = $("#ach-signature").val();
                } else if ($(".payment-option input").filter(":checked").attr("payment-method") == "wire") {
                    user_signature = $("#wire-signature").val();
                } else if ($(".payment-option input").filter(":checked").attr("payment-method") == "check") {
                    user_signature = $("#check-signature").val();
                }

                faSubscriptionAgreement(fa_invest_data);
                if (is_success == true) {
                    faSignature(fa_invest_data);
                }

                if (is_success == true) {
                    faEntity(fa_invest_data);
                }

                if (is_success == true) {
                    saveMeixinEntity(fa_invest_data);
                }

                if ($(".payment-option input").filter(":checked").attr("payment-method") == "ach") {
                    console.log("use ach");
                    faAchAuthorization(fa_invest_data);
                }


                if (is_success == true) {
                    faInvestment(fa_invest_data);
                }
                if (is_success == true) {
                    saveToMeixinOrder(fa_invest_data);
                }
                if (is_success == true) {
                    saveToMeixinPhoto(fa_invest_data);
                }
                if (is_success == true) {
                    $(".fa-steps-bullets, form.fa-steps").hide();
                    $(".invest_info").show();
                } else {
                    $(".fa-steps-bullets, form.fa-steps").hide();
                    $(".invest_info h2").text("投资失败" + ": " + error);
                    $(".invest_info p").first().text("您填写的投资信息有误，投资未成功。我们的工作人员将尽快与您联系。（美信的邮箱：invest@meixinfinance.com）");
                    $(".invest_info p:eq(1)").text("失败原因: " + error_detail);
                    $(".success-links").hide();
                    $(".invest_info").show();
                }
            }, 500);
        }
    });
</script>
</body>
</html>