<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
    <title>
        美信金融|投资流程
    </title>
    <link rel="stylesheet" href="${static}/vendor/css/bootstrap.min.css">
    <link href="${static}/dist/meixin_invest/css/base.min.css" rel="stylesheet">
    <link href="${static}/dist/meixin_invest/css/detail-new.min.css" rel="stylesheet">
    <link href="${static}/dist/meixin_invest/css/index.min.css" rel="stylesheet">
    <link href="${static}/dist/meixin_invest/css/fa_invest.min.css" rel="stylesheet">
    <#include "includes/oneapm.html" />
    <#include "includes/ga.html" />
    <script>
    var _hmt = _hmt || [];
    (function()
    { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?36100da860ed74085d2bdd67bdbdbf5e"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); }
    )();
    </script>
    <!--[if lt IE 9]>
    <script src="${static}/vendor/js/html5shiv"></script>
    <script src="${static}/vendor/js/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div id="wrapper" class="customer">
<#include "includes/navbar.html" />
<div class="container-fluid">
    <section class="text-center" style="margin-top: 70px;">
        <div class="row">
            <div class="col-sm-10 col-sm-offset-1">
                <div class="fa-steps-bullets">
                    <div><p><span>1</span></p>投资人基本信息</div>
                    <div><p><span>2</span></p>合格投资人身份</div>
                    <div><p><span>3</span></p>合格投资人信息</div>
                    <div><p><span>4</span></p>投资者身份</div>
                    <div><p><span>5</span></p>确认投资</div>
                    <hr/>
                    <span class="clearfix"></span>
                </div>
                <form class="fa-steps col-sm-10 col-sm-offset-1" data-parsley-validate>
                    <div class="step-section label-left">
                        <label>Full Name:</label>
                        <input id="full-name" class="form-control" equired="">
                        <label>SSN:</label>
                        <input id="ssn" name="ssn" class="form-control" required="" data-parsley-pattern="^\d{3}-\d{2}-\d{4}$"
                               data-parsley-pattern-message="SSN信息输入有误！" placeholder="XXX-XX-XXXX" maxlength="11">
                        <label>Date of Birth:</label>
                        <input type="text" id="birth-date" name="birthdate" placeholder="YYYY-MM-DD" class="form-control" required="" data-parsley-pattern="/(^(19|[2-9][0-9])\d\d[\-](((0[1-9]|1[012])[\-](0[1-9]|1[0-9]|2[0-8]))|((0[13578]|1[02])[\-](29|30|31))|((0[4,6,9]|11)[\-](29|30)))$)|(^(19|[2-9][0-9])(00|04|08|12|16|20|24|28|32|36|40|44|48|52|56|60|64|68|72|76|80|84|88|92|96)[\-]02[\-]29$)/" maxlength="10" data-parsley-pattern-message="Invalid Date of Birth format">
                        <label>Street Address:</label>
                        <input id="street" class="form-control" required="" onblur="ReplaceDot('street')">
                        <label>Apartment Number:</label>
                        <input id="apt-number" class="form-control" onblur="ReplaceDot('apt-number')">
                        <label>City:</label>
                        <input id="city" class="form-control" required="" onblur="ReplaceDot('city')">
                        <label>State:</label>
                        <select id="state" class="form-control bfh-states usa-state-field-style"
                                data-country="US" data-state="NY" required=""></select>
                        <label>Zip Code:</label>
                        <input id="zipcode" class="form-control" required="">
                    </div>
                    <div class="step-section text-left investor-type radio-custom">
                        <p>The information is needed for us to comply with SEC and state securities
                            regulations.</p>
                        <h5>Are you an "accredited" investor(meaning do have a net worth of at least one million US dollars, excluding the value of one's primary residence, or have income at least $200,000 each year for the last two years or $300,000 combined income if married and have the expectation to make the same amount this year, or are you an accredited institutional investor)?</h5>
                        <span id="accredited-investor">
                            <input type="radio" name="investorType" id="investor-type-yes" isaccredited="true"
                                   required/>
                            <label><span><span></span></span>Yes</label><br>
                            <input type="radio" name="investorType" id="investor-type-no" isaccredited="false"/>
                            <label><span><span></span></span>No</label>
                        </span>
                        <!--$("#accredited-investor input").filter(":checked").attr("isaccredited")-->

                        <div class="accredited-investor-box">
                            <h5>I qualified as an accredited investor as follows:</h5>
                            <input type="checkbox" name="USAInvestorType" id="usa-investor-1" amount="1000000"/>
                            <label for="usa-investor-1"><span><span></span></span>I have an individual net
                                worth, or joint net worth with my spouse, that exceeds $1 million including any
                                IRA's, 401K's and other retirement accounts, but excluding the net value of my
                                primary residence.</label><br>
                            <input type="checkbox" name="USAInvestorType" id="usa-investor-2" amount="250000"/>
                            <label for="usa-investor-2"><span><span></span></span>I am an individual with income
                                of over $200,000 in each of the last two years, or joint income with my spouse
                                exceeding $300,000 in those years, and I reasonably expect at least the same
                                this year.</label>
                            <!--$(".accredited-investor-box input").filter(":checked").attr("amount")-->
                        </div>
                    </div>
                    <div class="step-section text-left investor-type radio-custom">
                        <p>The SEC requires that investors in 506(c) offerings be "reasonably" confirmed as to
                            their accredited status. SEC 17 CFR Parts 230, 239 and 242 - Section 3. A, B &
                            C(Starting on page 26).</p>
                        <h5>There are a number of ways to do this. Please help us get this done by letting us
                            know whichever is easiest for you(check all that apply):</h5>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>Google me and you'll find enough information about
                                me to see that it's reasonable to assume I'm an accredited investor.</label><br>
                            <div class="investor-info-usa-box">
                                <label>Let us know what to find and where we'll find it:</label>
                                <input class="form-control"/>
                                <label>And here's my Linkedin profile(if any):</label>
                                <input class="form-control"/>
                            </div>
                        </div>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>Look at our website and you'll see it contains
                                inforation that will show it's reasonable to consider us accredited.</label><br>
                            <div class="investor-info-usa-box">
                                <label>Website(s)URL(s):</label>
                                <input class="form-control"/>
                            </div>
                        </div>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>Call my accountant, he/she will tell you I'm
                                accredited - Their info:</label><br>
                            <div class="investor-info-usa-box">
                                <label>Accountant Contact Information (include name, phone, email):</label>
                                <input class="form-control"/>
                            </div>
                        </div>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>Call my broker/registered investment adviser,
                                he/she will tell you I'm accredited — Their contact info:</label><br>
                            <div class="investor-info-usa-box">
                                <label>Broker Contact Info (include name, phone, email):</label>
                                <input class="form-control"/>
                            </div>
                        </div>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>Call my lawyer, he/she will tell you I'm accredited
                                — Their contact info:</label><br>
                            <div class="investor-info-usa-box">
                                <label>Lawyer Contact Info (include name, phone, email):</label>
                                <input class="form-control"/>
                            </div>
                        </div>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>I'll send you proof and email or fax my tax returns
                                (most recent 2 years, only gross income page(s) necessary). Send them to
                                accreditation@fundamerica.com or fax to (917) 791-8350.</label><br>
                            <div class="investor-info-usa-box">
                                <input class="form-control"/>
                            </div>
                        </div>
                        <div>
                            <input type="checkbox" name="investorInfoUSA" class="investor-info-usa"/>
                            <label><span><span></span></span>I'll send you proof and email or fax my bank
                                statement, my securities statement, my IRA or 401K statement(s), my financial
                                statement (prepared by a CPA), or other document(s) showing that my net worth
                                exceeds $1 million (excluding my primary residence, but including any secondary
                                or investment real estate). I will also send you a list of all my liabilities
                                (other than those associated with my primary residence) and hereby certify and
                                attest that I am disclosing all liabilities so you can make a reasonable
                                calculation that my net worth exceeds the Rule 506(c) requirement. I further
                                authorize FundAmerica Technologies and its third-party providers to obtain a
                                credit report to confirm my liabilities as required by SEC rules. Send documents
                                to accreditation@fundamerica.com or fax to (917) 791-8350.</label><br>
                            <div class="investor-info-usa-box">
                                <input class="form-control"/>
                            </div>
                        </div>
                        <h5>Other notes and things to consider (optional):</h5>
                        <input class="form-control"/>
                    </div>

                    <div class="step-section label-left radio-custom investor-type text-left">
                        <h5>Substitute Form W-9 Statement: Under penalty of perjury, by accepting the agreement
                            below I certify that I have provided my correct taxpayer identification number,
                            and</h5>
                        <span id="usa-if-us-citizen">
                            <input type="radio" name="usCitizenUSA" usCitizen="true" required="" />
                            <label><span><span></span></span>I am a US citizen, US resident, or other US person.</label><br>
                            
                            <input type="radio" name="usCitizenUSA" usCitizen="false"/>
                            <label><span><span></span></span>I am not a US citizen, US resident, or other US person.</label><br>
                        </span>
                        <h5>And:</h5>
                        <span id="usa-if-with-holding">
                            <input type="radio" name="backupWithholding" withHolding="true" required="" />
                            <label><span><span></span></span>I am exempt from backup withholding.</label><br>

                            <input type="radio" name="backupWithholding" withHolding="false"/>
                            <label><span><span></span></span>I am subject to backup withholding.(Only check this option if you've been notified by the IRS that you are subject to backup withholding)</label><br>
                        </span>
                    </div>

                    <div class="step-section payment-section text-left radio-custom label-left">
                        <label>投资金额：</label>
                        <input data-parsley-pattern="/^([1-9][0-9]{0,1}0000)$|^([1-9][0-9]{0,1}[5]000)$/" data-parsley-pattern-message="最低投资金额：$10,000，必须为5000的倍数" id="invest-amount" name="invest-amount" class="form-control"
                               placeholder="最低投资金额：$10,000，必须为5000的倍数" required="" onkeypress="return event.charCode === 0 || /\d/.test(String.fromCharCode(event.charCode));" />
                        <section>
                            <label>投资方式：</label>
                            <div class="payment-option">
                                <input type="radio" name="payment" id="ach-online" payment-method="ach" required="" data-parsley-required-message="请选择支付方式" />
                                <label for="ach-online"><span><span></span></span>ACH在线自动转账（最方便、需要美国银行账户、账户姓名需与投资人姓名一致）</label><br>
                                <input type="radio" name="payment" id="bank-tt" payment-method="wire" />
                                <label for="bank-tt"><span><span></span></span>银行电汇（从非美国银行账户）</label><br>

                                <input type="radio" name="payment" id="check" payment-method="check" />
                                <label for="check"><span><span></span></span>支票</label>
                            </div>
                        </section>
                        <div class="ach-online-box">
                            <label><img src="${static}/meixin_invest/img/fa_invest/fa_pay_name_60x58.png"/></label>
                            <input id="bank-account-name" class="form-control" placeholder="Name On Account" />
                            <label><img
                                    src="${static}/meixin_invest/img/fa_invest/fa_pay_routing_60x54.png"/></label>
                            <input id="routing-number" class="form-control"
                                   placeholder="9 Digit Bank Routing Number" />
                            <label><img
                                    src="${static}/meixin_invest/img/fa_invest/fa_pay_account_54x60.png"/></label>
                            <input id="bank-account-number" class="form-control"
                                   placeholder="Bank Account Number" />
                            <div class="accout-check-type">
                                <label>Accout Type</label>
                                <span id="accouttype">
                                <label for="accoutType-checking"><input type="radio" name="accoutType"
                                                                        id="accoutType-checking"
                                                                        accounttype="checking" /><span>Checking</span></label>
                                <label for="accoutType-saving"><input type="radio" name="accoutType"
                                                                      id="accoutType-saving"
                                                                      accounttype="savings"/><span>Savings</span></label>
                                </span>
                                <label>Check Type</label>
                                <span id="checktype">
                                <label for="checkType-personal"><input type="radio" name="checkType"
                                                                       id="checkType-personal"
                                                                       checktype="personal" /><span>Personal</span></label>
                                <label for="checkType-business"><input type="radio" name="checkType"
                                                                       id="checkType-business"
                                                                       checktype="business"/><span>Business</span></label>
                                </span>
                            </div>
                            <input type="checkbox" name="agreement" id="achAgreement" />
                            <label for="achAgreement"><span><span></span></span>我已认真阅读并接受<a href="${static}/meixin_invest/doc/ACH-AUTHORIZATION-AGREEMENT.pdf" target="blank">《ACH AUTHORIZATION
                                AGREEMENT》</a></label><br>
                            <input type="checkbox" name="agreement" id="agreement-01" />
             
                            <label for="agreement-01"><span><span></span></span>我已认真阅读并接受<a
                                    href="${static}/meixin_invest/doc/${product.subscription_agreement_name}"
                                    target="blank">《认购协议》</a></label>
          
                            <div class="sign-name">
                                <label>签名：</label>
                                <input id="ach-signature" class="form-control" placeholder="请输入您的名字与姓的拼音以确认"
                                       name="signature" />
                            </div>
                        </div>
                        <div class="bank-tt-box">
                            <p><span>汇款信息：</span></p>
                            <p><span>备注栏请填写：</span>
                            <input type="checkbox" name="agreement" id="agreement-01" />

                                YOUR NAME  ${product.external_name}

                            </p>
                            <p><span>收款人名字：</span>Fund America Securities, LLC</p>
                            <p><span>收款人地址：</span>3455 Peachtree Road, NE 5th Floor Atlanta, GA 30325</p>
                            <p><span>账户号Account #：</span>0001476100</p>
                            <p><span>收款路径号ABA/Routing #：</span>122242869</p>
                            <p><span>Swift Code：</span>PMERU66</p>
                            <p><span>收款银行：</span>Pacific Mercantile Bank</p>
                            <p><span>收款银行地址：</span>949 South Coast Drive, Third Floor Costa Mesa, CA 92626,
                                (714)438-2500</p>
                            <p><span>注意：请您在接收到我们邮件通知您投资人身份审核通过后再前往银行进行汇款</span></p>
                            <input type="radio" name="agreement" id="agreement-02" data-parsley-required-message="请阅读并接受认购协议" />
          
                            <label for="agreement-02"><span><span></span></span>我已认真阅读并接受<a
                                    href="${static}/meixin_invest/doc/${product.subscription_agreement_name}"
                                    target="blank">《认购协议》</a></label>
                 
                            <div class="sign-name">
                                <label>签名：</label>
                                <input id="wire-signature" class="form-control" placeholder="请输入您的名字与姓的拼音以确认">
                            </div>
                        </div>
                        <div class="check-box">
                            <p><span>收款人：</span>FUNDAMERICA SECURITIES</p>
                            <p><span>备注栏请填写：</span>
                            <input type="checkbox" name="agreement" id="agreement-01" />
                                YOUR NAME & ${product.external_name}
                            </p>
                            <p><span>请将支票寄至以下地址：</span></p>
                            <p>FundAmerica Securities</p>
                            <p>3455 Peachtree Road, NE</p>
                            <p>5th Floor</p>
                            <p>Atlanta, GA 30326</p>
                            <p><span>注意：我们目前只接受来自美国银行账户的支票</span></p>
                            <input type="radio" name="agreement" id="agreement-03" data-parsley-required-message="请阅读并接受认购协议" />
      
                            <label for="agreement-03"><span><span></span></span>我已认真阅读并接受<a
                                    href="${static}/meixin_invest/doc/${product.subscription_agreement_name}"
                                    target="blank">《认购协议》</a></label>
                           
                            <div class="sign-name">
                                <label>签名：</label>
                                <input id="check-signature" class="form-control" placeholder="请输入您的名字与姓的拼音以确认" >
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="previous btn btn-primary pull-left">返回</button>
                        <button type="button" class="next btn btn-primary pull-right">下一步</button>
                        <button type="fasubmit" id="submit-button" class="btn btn-primary pull-right"><span class="glyphicon glyphicon-refresh spinning" style="display: none;"></span><span>提交</span></button>
                            <span class="clearfix"></span>
                        </div>
                    </form>
                    <div class="invest_info">
                        <h2>申购成功</h2>
                        <p>您的款项到账后将收到邮件通知</p>
                        <p></p>
                        <div class="row success-links">
                            <h3>与此同时，您还可以：</h3>
                            <div class="col-sm-offset-3 col-sm-2">
                                <img src="${static}/meixin_invest/img/fa_invest/icon_moreproducts_512x512.png" />
                                <a href="/product_list" target="_blank" class="btn btn-primary">浏览更多产品</a>
                            </div>
                            <div class="col-sm-2">
                                <img src="${static}/meixin_invest/img/fa_invest/icon_myaccount_512x512.png" />
                                <a href="/investor/dashboard" target="_blank" class="btn btn-primary">查看我的账户</a>
                            </div>
                            <div class="col-sm-2">
                                <img src="${static}/meixin_invest/img/fa_invest/icon_news_512x512.png" />
                                <a href="//news.meixinfinance.com" target="_blank" class="btn btn-primary">查看财经资讯</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
<#include "includes/footer.html" />
<link rel="shortcut icon" type="image/png" href="${static}/dist/meixin_invest/img/favicon.png">
<link rel="stylesheet" href="${static}/vendor/css/font-awesome.min.css">
<script src="${static}/vendor/js/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="${static}/vendor/js/jquery-ui.min.js" type="text/javascript"></script>
<script src="${static}/vendor/js/bootstrap.min.js" type="text/javascript"></script>
<script src="${static}/dist/meixin_invest/js/navi.min.js" type="text/javascript"></script>
<script>
    $(document).ready(function(){
        $('#wechat-popover').popover({
            html : true,
            placement : 'bottom',
            trigger : 'hover',
            content : '<img style="width: 200px;padding:0;margin:0;" src="${static}/meixin_invest/img/meixin_new_qr_code_300x300.jpg" />'
        });
    });
</script>
<script src="${static}/dist/meixin_invest/js/bootstrap-formhelpers.min.js"></script>
<script src="${static}/dist/meixin_invest/js/bootstrap-formhelpers-states.min.js"></script>
<script src="${static}/dist/meixin_invest/js/bootstrap-formhelpers-countries-nousa.zh_CN.min.js"></script>
<script src="${static}/meixin_invest/js/parsley.min.js"></script>
<script src="${static}/dist/meixin_invest/js/fa_invest_general.min.js"></script>
<script src="${static}/dist/meixin_invest/js/jquery.cookie.min.js"></script>
<script src="${static}/dist/meixin_invest/js/fa.min.js"></script>
<script>
    function ReplaceDot(id){
        var Obj=document.getElementById(id);
        while(Obj.value.indexOf("。")!=-1 || Obj.value.indexOf("，")!=-1){
            Obj.value=Obj.value.replace("。",".");
            Obj.value=Obj.value.replace("，",",");
        }
    }
    function getUserInvestorProfile(fa_invest_data) {
        // get investor profile from meixin database
        $.ajax({
            url: '/api/investor/investor_profile',
            dataType: 'json',
            async: false,
            data: {},
            success: function (result, status) {
                fa_invest_data['user_id'] = result.user_id;
                fa_invest_data['entity_id'] = result.entity_id;
                console.log(result);
            },
            error: function(result, status) {
                console.log(error);
            },
            fail: function(result, status) {
            },
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    function getFaEntity(fa_invest_data) {
        // get FA entity information
        console.log(fa_invest_data['entity_id']);
        console.log("getFaEntity");
        $.ajax({
            url: '/fund_america/entities' + '/' + fa_invest_data['entity_id'],
            dataType: 'json',
            method: 'GET',
            async: false,
            data: {},
            success: function (result, status) {
                console.log(result);
                $("#full-name").attr("value", result.name);
                $("#date-of-birth").attr("value", result.date_of_birth);
                $("#street").attr("value", result.street_address_1);
                $("#zipcode").attr("value", result.postal_code);
                $("#city").attr("value", result.city);
                fa_invest_data['phone'] = result.phone;
            },
            error: function (response) {
                console.log(response);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 1: Subscription Agreement
    function faSubscriptionAgreement(data) {
        $.ajax({
            url: '/fund_america/subscription_agreements',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'equity_share_count': 10,
                'offering_id': "${offering_id}",
                'vesting_amount': $("#invest-amount").val(),
                'vesting_as': user_signature,
                'vesting_as_email': '${user.email}',
                'debt_par_value': 5000,
            },
            success: function (result, status) {
                console.log(result);
                console.log("post success");
                data['agreement_id'] = result.id;
                data['agreement_url'] = result.url;
                if (result.electronic_signatures[0]['anchor_id'] == 'subscriber_signature') {
                    data['sign_id'] = result.electronic_signatures[0].id;
                } else {
                    data['sign_id'] = result.electronic_signatures[1].id;
                }
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "协议填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 2: Electronic Signature
    function faSignature(data) {
        $.ajax({
            url: '/fund_america/electronic_signatures' + '/' + data['sign_id'],
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'ip_address': '${user_ip}',
                'name': user_signature,
                'email': '${user.email}',
                'user_agent': window.navigator.userAgent,
                'literal': user_signature
            },
            success: function (result, status) {
                console.log("fa sign success");
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "签名有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 3: Entity
    function faEntity(data) {
        var phone = '';
        if(data['phone']){
            phone = data['phone'];
        }else{
            phone = '${investor_profile.telephone}';
        }


        $.ajax({
            url: '/fund_america/entities',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'country': 'US',
                'region': $("#state").find("option").filter(":selected").attr("value"),
                'city': $('#city').val(),
                'street_address_1': $('#street').val(),
                'street_address_1': $('#apt-number').val(),
                'postal_code': $('#zipcode').val(),
                'email': '${user.email}',
                'phone': phone,
                'name': $("#full-name").val(),
                'date_of_birth': $('#birth-date').val(),
                'tax_id_number': $('#ssn').val().replace(/\D/g,''),
                'type': 'person',
                'entity_type': 'person'
            },
            success: function (result, status) {
                console.log("save fa entity");
                data['entity_id'] = result.id;
                console.log(data['entity_id']);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "投资人信息填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }


    // FA API Call 4: Accreditation
    function faAccreditation(data) {
        $.ajax({
            url: '/fund_america/entities' + '/' + data['entity_id'] + '/investor_accreditation/',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                type: 'individual_net_worth',
                us_citizen_or_resident: $("#usa-if-us-citizen input").filter(":checked").attr("usCitizen"),
                exempt_from_withholding: $("#usa-if-with-holding input").filter(":checked").attr("withHolding"),
                confirmation_methods: 'will_send_proof',
                annual_income: 250000,
                net_worth: 1000000
            },
            success: function (result, status) {
                console.log("fa_accreditation success");
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "投资人资质填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 5 (Optional): ACH
    function faAchAuthorization(data) {
        $.ajax({
            url: '/fund_america/achs',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'account_number': $('#bank-account-number').val(),
                'account_type': $("#accouttype input").filter(":checked").attr("accounttype"),
                'address': $('#street').val(),
                'check_type': $("#checktype input").filter(":checked").attr("checktype"),
                'city': $('#city').val(),
                'email': '${user.email}',
                'entity_id': data['entity_id'], //'5GSfRkqvRL-pcM_qNWIfng', //
                'ip_address': '${user_ip}',
                'literal': user_signature,
                'name_on_account': $('#bank-account-name').val(),
                'routing_number': $('#routing-number').val(),
                'state': $("#state").find("option").filter(":selected").attr("value"),
                'user_agent': user_browser,
                'zip_code': $('#zipcode').val(),
            },
            success: function (result, status) {
                console.log(data);
                console.log("ach call success");
                data['ach_authorization_id'] = result.id;
            },
            error: function (response) {
                console.log(data);
                console.log(response);
                is_success = false;
                error = "ACH填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // FA API Call 6: Investments
    function faInvestment(data) {
        var now = {
            'offering_id': '${offering_id}',
            'amount': $("#invest-amount").val(),
            'entity_id': data['entity_id'],
            'subscription_agreement_id': data['agreement_id'],
            'payment_method': $(".payment-option input").filter(":checked").attr("payment-method"),
            'review_trade': 'false'
        };
        if ($(".payment-option input").filter(":checked").attr("payment-method") == 'ach') {
            now['ach_authorization_id'] = data['ach_authorization_id'];
        }
        $.ajax({
            url: '/fund_america/investments',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: now,
            success: function (result, status) {
                console.log('invest success');
                data['external_id'] = result.id;
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "投资填写有误";
                error_detail = response.responseText;
                console.log(error_detail);
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // Meixin Order Api Call
    function saveMeixinOrder(data) {
        $.ajax({
            url: '/api/orders',
            dataType: 'json',
            method: 'POST',
            async: false,
            data: {
                'product': "${product.id}",
                'invest_amount': $("#invest-amount").val(),
                'payment_method': $(".payment-option input").filter(":checked").attr("payment-method"),
                'external_id': data['external_id']
            },
            success: function (result, status) {
                console.log('order save success');
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "订单填写有误";
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    // Meixin Profile Api Call
    function saveMeixinEntity(data) {
        $.ajax({
            url: '/api/investor/update_investor_profile',
            dataType: 'json',
            method: 'post',
            data: {
                'external_entity_id': data['entity_id'],
                'real_name': $("#firstname").val() + " " + $("#lastname").val(),
                'id_card_code': $("#id-card-number data").val(),
            },
            success: function (result, status) {
                console.log('meixin entity save success');
                console.log(result);
            },
            error: function (response) {
                console.log(response);
                is_success = false;
                error = "用户信息存储有误";
            },
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('access_token'));
            }
        });
    }

    var user_browser;
    var user_signature;
    var fa_invest_data = {}
    var is_success = true;
    var error;
    var error_detail;

    $(document).ready(function () {
        user_browser = window.navigator.appName;
        console.log(user_browser);
        getUserInvestorProfile(fa_invest_data);
        console.log(fa_invest_data['entity_id']);

        getFaEntity(fa_invest_data);
    });

    function curIndex() {
        return $('.step-section').index($('.step-section').filter('.current'));
    }

    // handle submission
    $('#submit-button').click(function () {
        if ($('.fa-steps').parsley().validate({group: 'block-' + curIndex()})){

            $('#submit-button').attr("disabled","disabled");
            $('#submit-button span').eq(0).show();
            $('#submit-button span').eq(1).text(" 提交中...");

            setTimeout(function () {
                if ($(".payment-option input").filter(":checked").attr("payment-method") == "ach") {
                    user_signature = $("#ach-signature").val();
                } else if ($(".payment-option input").filter(":checked").attr("payment-method") == "wire") {
                    user_signature = $("#wire-signature").val();
                } else if ($(".payment-option input").filter(":checked").attr("payment-method") == "check") {
                    user_signature = $("#check-signature").val();
                }

                faSubscriptionAgreement(fa_invest_data);
                if (is_success == true) {
                    faSignature(fa_invest_data);
                } else {
                    error = "投资人条件填写有误";
                }

                if (is_success == true && fa_invest_data['entity_id'].length == 0) {
                    faEntity(fa_invest_data);
                    saveMeixinEntity(fa_invest_data);
                } else {
                    error = "ACH填写有误";
                }

                if (is_success == true) {
                    faAccreditation(fa_invest_data);
                } else {
                    error = "投资人资质填写有误";
                }

                if ($(".payment-option input").filter(":checked").attr("payment-method") == "ach") {
                    faAchAuthorization(fa_invest_data);
                } else {
                    error = "ACH填写有误";
                }

                if (is_success == true) {
                    faInvestment(fa_invest_data);
                } else {
                    error = "投资填写有误";
                }
                if (is_success == true) {
                    saveMeixinOrder(fa_invest_data);
                } else {
                    error = "订单填写有误";
                }

                if (is_success == true) {
                    $(".fa-steps-bullets, form.fa-steps").hide();
                    $(".invest_info").show();
                } else {
                    $(".fa-steps-bullets, form.fa-steps").hide();
                    $(".invest_info h2").text("投资失败");
                    $(".invest_info p").first().text("您填写的投资信息有误，投资未成功。我们的工作人员将尽快与您联系。（美信的邮箱：invest@meixinfinance.com）");
                    $(".invest_info p:eq(1)").text("失败原因: "+ error_detail);
                    $(".success-links").hide();
                    $(".invest_info").show();
                }
            }, 500);
        }
    });
</script>
</body>
</html>

